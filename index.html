<!doctype html>
<html lang="kk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ойконимдер ойыны — «Елді мекендер және атаулар»</title>
  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --accent: #7dd3fc;
      --good: #34d399;
      --bad: #fb7185;
      --warn: #fbbf24;
      --border: rgba(255,255,255,.14);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: "Times New Roman", Times, serif;
      font-size: 16px;
      color:var(--text);
      background: radial-gradient(1100px 650px at 20% 10%, rgba(125,211,252,.18), transparent 60%),
                  radial-gradient(900px 600px at 90% 15%, rgba(52,211,153,.14), transparent 60%),
                  radial-gradient(900px 700px at 40% 95%, rgba(251,191,36,.10), transparent 60%),
                  var(--bg);
      display:flex;
      justify-content:center;
      padding: 26px 14px 40px;
    }
    a{ color:var(--accent); }
    .wrap{ width:min(1100px, 100%); }
    header{
      display:flex; gap:16px; align-items:flex-start; justify-content:space-between;
      padding: 18px 18px 14px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .title h1{
      margin:0;
      font-size: 28px;
      letter-spacing:.2px;
    }
    .title p{ margin:8px 0 0; color:var(--muted); line-height:1.35; }
    .badgeRow{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .badge{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size: 14px;
      white-space:nowrap;
    }
    .badge b{ color: var(--text); font-weight:700; }
    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 330px 1fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 920px){
      .grid{ grid-template-columns: 1fr; }
      .badgeRow{ justify-content:flex-start; }
    }
    .card{
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .hd h2{
      margin:0;
      font-size: 18px;
      letter-spacing:.2px;
    }
    .card .bd{ padding: 14px 16px 16px; }
    .muted{ color:var(--muted); }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      appearance:none;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      font-family: inherit;
      font-size: 15px;
      box-shadow: 0 8px 18px rgba(0,0,0,.22);
    }
    button:hover{ background: rgba(255,255,255,.10); border-color: rgba(125,211,252,.35); }
    button:active{ transform: translateY(1px); }
    button.primary{
      background: linear-gradient(180deg, rgba(125,211,252,.25), rgba(125,211,252,.10));
      border-color: rgba(125,211,252,.35);
    }
    button.good{
      background: linear-gradient(180deg, rgba(52,211,153,.22), rgba(52,211,153,.10));
      border-color: rgba(52,211,153,.35);
    }
    button.bad{
      background: linear-gradient(180deg, rgba(251,113,133,.22), rgba(251,113,133,.10));
      border-color: rgba(251,113,133,.35);
    }
    button.ghost{ box-shadow:none; background: transparent; }
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; }
    .tabBtn[aria-selected="true"]{
      background: rgba(255,255,255,.12);
      border-color: rgba(255,255,255,.25);
    }
    .kpi{
      display:grid; grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    .kpi .box{
      padding: 10px 12px;
      border:1px solid var(--border);
      border-radius: 16px;
      background: rgba(255,255,255,.04);
    }
    .kpi .box .v{ font-size: 20px; font-weight:700; margin-top: 4px; }
    .divider{ height:1px; background: var(--border); margin: 12px 0; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size: 14px;
    }
    .pill .dot{ width:8px; height:8px; border-radius:99px; background: var(--accent); }
    .sectionTitle{ margin:0 0 6px; font-size: 20px; }
    .qName{
      font-size: 28px; margin: 8px 0 4px; font-weight:700; letter-spacing:.2px;
    }
    .qHint{ margin: 0; color: var(--muted); }
    .choices{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
    @media (max-width: 700px){ .choices{ grid-template-columns: 1fr; } }
    .choice{
      text-align:left;
      padding: 12px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.05);
      border: 1px solid var(--border);
      cursor:pointer;
    }
    .choice:hover{ background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.22); }
    .choice small{ display:block; color: var(--muted); margin-top: 4px; line-height:1.25; }
    .choice.correct{ border-color: rgba(52,211,153,.5); background: rgba(52,211,153,.12); }
    .choice.wrong{ border-color: rgba(251,113,133,.55); background: rgba(251,113,133,.12); }
    .explain{
      margin-top: 12px;
      padding: 12px 12px;
      border:1px dashed rgba(255,255,255,.22);
      border-radius: 16px;
      background: rgba(0,0,0,.10);
      color: var(--text);
      line-height: 1.35;
    }
    .explain b{ color: var(--accent); }
    .flex{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .right{ margin-left:auto; }
    .progress{
      height: 10px;
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
    }
    .progress > div{
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(125,211,252,.9), rgba(52,211,153,.85));
      border-radius: 999px;
      transition: width .3s ease;
    }
    .mini{
      font-size: 14px;
      color: var(--muted);
    }
    .toast{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      display:none;
    }
    .toast.show{ display:block; }
    .builderRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    @media (max-width: 820px){ .builderRow{ grid-template-columns: 1fr; } }
    .dropZone{
      border: 1px dashed rgba(255,255,255,.22);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 12px;
      min-height: 80px;
    }
    .dropZone h3{ margin:0 0 8px; font-size: 16px; }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      cursor:grab;
      user-select:none;
      font-size: 14px;
    }
    .chip:active{ cursor:grabbing; }
    .slot{
      margin-top: 10px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      padding: 10px;
      min-height: 64px;
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .slot.empty{ color: rgba(255,255,255,.45); }
    .bigWord{
      font-size: 28px;
      font-weight: 700;
      letter-spacing:.2px;
      margin: 8px 0 0;
    }
    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
    }
    .table th,.table td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      vertical-align: top;
      line-height:1.25;
    }
    .table th{ text-align:left; background: rgba(255,255,255,.04); color: var(--text); }
    .table td{ color: var(--muted); }
    footer{
      margin-top: 14px;
      padding: 12px 16px;
      color: rgba(255,255,255,.60);
      font-size: 13px;
      text-align:center;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding: 2px 6px;
      border: 1px solid rgba(255,255,255,.18);
      border-bottom-color: rgba(255,255,255,.28);
      border-radius: 8px;
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.80);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Ойконимдер ойыны: «Қазақстандағы елді мекендер»</h1>
        <p>
          Оқу мақсаты (9.4.1.7): елді мекендерді жіктеу және ойконимдердің мағынасына қарай топтастыру дағдысын дамыту.
          Ойын сабақта қолдануға лайық: теория + тапсырма + кері байланыс.
        </p>
      </div>
      <div class="badgeRow" aria-label="Негізгі көрсеткіштер">
        <div class="badge"><b>Режим:</b> <span id="modeName">Ойконимді тап</span></div>
        <div class="badge"><b>Ұпай:</b> <span id="scoreTop">0</span></div>
        <div class="badge"><b>Рекорд:</b> <span id="bestTop">0</span></div>
      </div>
    </header>

    <div class="grid">
      <section class="card" aria-label="Басқару панелі">
        <div class="hd">
          <h2>Басқару</h2>
          <button class="ghost" id="resetAllBtn" title="Ұпай мен рекордты тазарту">Тазарту</button>
        </div>
        <div class="bd">
          <div class="tabs" role="tablist" aria-label="Режим таңдау">
            <button class="tabBtn primary" role="tab" aria-selected="true" aria-controls="viewQuiz" id="tabQuiz">Ойконимді тап</button>
            <button class="tabBtn" role="tab" aria-selected="false" aria-controls="viewBuilder" id="tabBuilder">Құрастыр</button>
            <button class="tabBtn" role="tab" aria-selected="false" aria-controls="viewTheory" id="tabTheory">Теория</button>
          </div>

          <div class="kpi" aria-label="Сессия статистикасы">
            <div class="box">
              <div class="mini">Сұрақ</div>
              <div class="v"><span id="qNow">0</span>/<span id="qTotal">12</span></div>
            </div>
            <div class="box">
              <div class="mini">Дұрыс</div>
              <div class="v"><span id="rightNow">0</span></div>
            </div>
            <div class="box">
              <div class="mini">Серия</div>
              <div class="v"><span id="streakNow">0</span></div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="pill" title="Пернетақта қысқаша">
            <span class="dot"></span>
            <span>Таңдау: <span class="kbd">1</span> <span class="kbd">2</span> <span class="kbd">3</span> <span class="kbd">4</span> • Келесі: <span class="kbd">Enter</span></span>
          </div>

          <div class="divider"></div>

          <p class="muted" style="margin:0 0 8px">
            <b>Ойконим</b> — елді мекен атауы. Топтастыру үшін атаудың құрамын (түбір, анықтауыш, тарихи дерек) және
            табиғи-географиялық/әлеуметтік факторларды салыстыру қажет.
          </p>

          <div class="progress" aria-label="Прогресс">
            <div id="progBar"></div>
          </div>

          <div id="toast" class="toast" role="status" aria-live="polite"></div>
        </div>
      </section>

      <main class="card" aria-label="Ойын аймағы">
        <div class="hd">
          <h2 id="viewTitle">Ойконимді тап</h2>
          <div class="flex right">
            <button id="newRoundBtn" class="good" title="Жаңа сессия бастау">Жаңа раунд</button>
            <button id="nextBtn" class="primary" title="Келесі қадам">Келесі</button>
          </div>
        </div>

        <div class="bd">
          <section id="viewQuiz" role="tabpanel" aria-labelledby="tabQuiz">
            <p class="muted" style="margin:0 0 8px">
              Берілген ойконимнің <b>мағыналық тобы</b> мен <b>уәжін</b> таңда: атау табиғи белгіге ме,
              флора/фаунаға ма, тарихи-мәдени дерекке ме, әлде шаруашылық қызметке ме негізделгенін анықта.
            </p>

            <div class="pill" style="margin-top:10px">
              <span class="dot"></span>
              <span><b>Нұсқаулық:</b> жауапты таңдаған соң қысқаша түсіндірме шығады.</span>
            </div>

            <div style="margin-top: 10px">
              <div class="qName" id="qName">—</div>
              <p class="qHint" id="qHint">—</p>
            </div>

            <div class="choices" id="choices"></div>

            <div class="explain" id="explainBox" style="display:none"></div>
          </section>

          <section id="viewBuilder" role="tabpanel" aria-labelledby="tabBuilder" hidden>
            <p class="muted" style="margin:0 0 8px">
              Төмендегі морфемаларды пайдаланып, ойконим құрастыр. Құрастырылған атауға сәйкес
              <b>мағына</b> мен <b>топ</b> шығады (деректер оқу мақсатымен ықшамдалған).
            </p>

            <div class="builderRow">
              <div class="dropZone" aria-label="Құрастыру материалдары">
                <h3>Компоненттер (сүйреп апар)</h3>
                <div class="chips" id="chips"></div>
                <p class="muted" style="margin:10px 0 0; font-size:14px">
                  Кеңес: анықтауыш (ақ/қара/сары/көкше, талды, темір, жез) + географиялық термин (су, тау, төбе, қорған, орда).
                </p>
              </div>

              <div class="dropZone" aria-label="Құрастыру аймағы">
                <h3>Құрастыру аймағы</h3>
                <div class="slot empty" id="slotA" data-slot="A">1-бөлік (мысалы: Ақ, Қара, Талды…)</div>
                <div class="slot empty" id="slotB" data-slot="B">2-бөлік (мысалы: су, тау, төбе…)</div>
                <div class="divider"></div>
                <div class="mini">Нәтиже</div>
                <div class="bigWord" id="builtWord">—</div>
                <div class="divider"></div>
                <div class="explain" id="buildExplain" style="display:none"></div>
                <div class="btnRow" style="margin-top:10px">
                  <button id="checkBuildBtn" class="primary">Тексеру</button>
                  <button id="clearBuildBtn">Тазалау</button>
                  <button id="randomBuildBtn" class="good">Кездейсоқ</button>
                </div>
              </div>
            </div>
          </section>

          <section id="viewTheory" role="tabpanel" aria-labelledby="tabTheory" hidden>
            <h3 class="sectionTitle" style="margin-top:0">Қысқаша теория</h3>
            <p class="muted" style="margin:0 0 10px; line-height:1.35">
              Ойконимдерді талдауда екі қадам маңызды: (1) <b>құрамдық талдау</b> (түбір, анықтауыш, тарихи қабат),
              (2) <b>мағыналық уәж</b> (табиғи орта, флора/фауна, шаруашылық, тарихи-мәдени фактор).
              Бір атаудың бірнеше нұсқалы түсіндірмесі кездесуі ықтимал, сондықтан дәлел ретінде карта, мұрағат,
              тарихи дерек және жергілікті топонимиялық материалдар салыстырылады.
            </p>

            <table class="table" aria-label="Мағыналық топтар кестесі">
              <thead>
                <tr>
                  <th>Топ</th>
                  <th>Негізгі белгі</th>
                  <th>Мысал үлгілер</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><b>Табиғи-географиялық</b></td>
                  <td>Жер бедері, су, түс, кеңістік сипат</td>
                  <td>Ақсу, Көкшетау, Қаратау, Шалқар</td>
                </tr>
                <tr>
                  <td><b>Флора/фауна</b></td>
                  <td>Өсімдік, жануар атаулары, биота</td>
                  <td>Қарағанды, Сарыағаш, Талдықорған</td>
                </tr>
                <tr>
                  <td><b>Тарихи-мәдени</b></td>
                  <td>Тарихи оқиға, діни/мәдени атау, әкімшілік-символдық мән</td>
                  <td>Түркістан, Петропавл, Қызылорда</td>
                </tr>
                <tr>
                  <td><b>Шаруашылық-экономикалық</b></td>
                  <td>Кен өндіру, өндіріс, кәсіп, еңбек сипаты</td>
                  <td>Жезқазған, Теміртау</td>
                </tr>
              </tbody>
            </table>

            <div class="divider"></div>

            <h3 class="sectionTitle">Сабаққа кіріктіру идеясы</h3>
            <ul class="muted" style="margin:6px 0 0; line-height:1.4">
              <li><b>Топтық жұмыс:</b> әр топқа 3–4 ойконим беріп, уәжін дәлелдету (атлас/карта, тарихи дерек).</li>
              <li><b>Жұптық талдау:</b> атаудың құрамын бөліп, компоненттердің географиялық мағынасын ашу.</li>
              <li><b>Рефлексия:</b> «3–2–1»: 3 маңызды ұғым, 2 дәлел, 1 сұрақ.</li>
            </ul>
          </section>
        </div>
      </main>
    </div>

    <footer>
      © Оқу-дидактикалық нұсқа. Топонимиялық түсіндірмелер оқу мақсатына сай ықшамдалған; кей атаулардың балама уәжі болуы мүмкін.
    </footer>
  </div>

  <script>
    const CATS = [
      { key: "natural", name: "Табиғи-географиялық", desc: "Жер бедері/су/түс/кеңістік белгі" },
      { key: "bio",     name: "Флора/фауна",         desc: "Өсімдік-жануар уәжі" },
      { key: "history", name: "Тарихи-мәдени",       desc: "Тарих, мәдениет, діни/әкімшілік мән" },
      { key: "econ",    name: "Шаруашылық-экономикалық", desc: "Кен, өндіріс, кәсіп уәжі" },
    ];

    const DATA = [
      { name:"Ақтөбе",     cat:"natural", hint:"Құрамын ойла: түс + жер бедері термині",
        explain:"Компоненттер: <b>ақ</b> + <b>төбе</b>. Түстік белгі мен жер бедеріне сүйенген ойконим." },
      { name:"Ақсу",       cat:"natural", hint:"Су нысаны атауы кейін елді мекенге ауысуы мүмкін",
        explain:"Компоненттер: <b>ақ</b> + <b>су</b>. Гидрологиялық белгі (өзен/су) негізінде қалыптасқан атау." },
      { name:"Көкшетау",   cat:"natural", hint:"Түс атауы + тау термині",
        explain:"Компоненттер: <b>көкше</b> + <b>тау</b>. Рельефке және кеңістік бейнесіне қатысты уәж." },
      { name:"Қаратау",    cat:"natural", hint:"Түс атауы + тау термині",
        explain:"Компоненттер: <b>қара</b> + <b>тау</b>. Түстік-геоморфологиялық белгіге негізделген ойконим." },
      { name:"Атырау",     cat:"natural", hint:"Өзен сағасы, тармақтану, дельта ұғымымен байланыс",
        explain:"Табиғи-географиялық уәж: өзен сағасы мен тармақтану аймағына қатысты атау." },
      { name:"Шалқар",     cat:"natural", hint:"Кең, ұлан-ғайыр деген семантика",
        explain:"Лексикалық мағынасы кеңістік сипатқа жақын: <b>шалқар</b> — кең, ауқымды." },

      { name:"Қарағанды",  cat:"bio", hint:"Өсімдік атауын еске түсір",
        explain:"Өсімдік уәжі: <b>қараған</b> бұтасының таралуымен байланыстырылатын ойконим." },
      { name:"Сарыағаш",   cat:"bio", hint:"Түс атауы + өсімдік/ағаш",
        explain:"Компоненттер: <b>сары</b> + <b>ағаш</b>. Биота (өсімдік) белгісі қатысады." },
      { name:"Талдықорған",cat:"bio", hint:"Өсімдік + қорған (бекініс)",
        explain:"Компоненттер: <b>талды</b> (тал өскен) + <b>қорған</b>. Өсімдік белгісі мен тарихи термин қабаттасады." },

      { name:"Түркістан",  cat:"history", hint:"Аймақтық-тарихи атау, мәдени қабат",
        explain:"Тарихи-мәдени уәж: өңірлік тарихи атау, мәдени-діни орталық ретінде танылған топоним." },
      { name:"Петропавл",  cat:"history", hint:"Антропонимдік/діни дәстүрмен байланысты атау",
        explain:"Тарихи-мәдени уәж: антропонимдік және діни дәстүрдегі есімдер қабаты (Петр–Павел)." },
      { name:"Қызылорда",  cat:"history", hint:"Түс атауы + орда (орталық) термині",
        explain:"Компоненттер: <b>қызыл</b> + <b>орда</b>. Әкімшілік-символдық мәні басым тарихи қабат." },

      { name:"Жезқазған",  cat:"econ", hint:"Металл + еңбек әрекеті (қазу)",
        explain:"Компоненттер: <b>жез</b> + <b>қазған</b>. Кен өндірумен байланысты шаруашылық уәжі." },
      { name:"Теміртау",   cat:"econ", hint:"Металл атауы + тау термині",
        explain:"Компоненттер: <b>темір</b> + <b>тау</b>. Өндіріс/металлургиямен қабаттасатын уәж." },
    ];

    const PART_A = ["Ақ","Қара","Сары","Көкше","Талды","Темір","Жез","Қызыл"];
    const PART_B = ["су","тау","төбе","қорған","орда"];

    const NORMALIZE = (s) => s.toLowerCase().replaceAll(" ","").replaceAll("-","");

    const state = {
      mode:"quiz", total:12, order:[], idx:0, locked:false,
      score:0, right:0, streak:0, best:0,
      buildA:null, buildB:null
    };
    const LS_BEST = "oikonym_best_score_v1";

    const $ = (id)=>document.getElementById(id);
    const tabQuiz=$("tabQuiz"), tabBuilder=$("tabBuilder"), tabTheory=$("tabTheory");
    const viewQuiz=$("viewQuiz"), viewBuilder=$("viewBuilder"), viewTheory=$("viewTheory");
    const viewTitle=$("viewTitle"), modeName=$("modeName"), scoreTop=$("scoreTop"), bestTop=$("bestTop");
    const qNow=$("qNow"), qTotal=$("qTotal"), rightNow=$("rightNow"), streakNow=$("streakNow"), progBar=$("progBar");
    const qName=$("qName"), qHint=$("qHint"), choices=$("choices"), explainBox=$("explainBox");
    const toast=$("toast");
    const newRoundBtn=$("newRoundBtn"), nextBtn=$("nextBtn"), resetAllBtn=$("resetAllBtn");

    const chips=$("chips"), slotA=$("slotA"), slotB=$("slotB"), builtWord=$("builtWord");
    const buildExplain=$("buildExplain"), checkBuildBtn=$("checkBuildBtn"), clearBuildBtn=$("clearBuildBtn"), randomBuildBtn=$("randomBuildBtn");

    function shuffle(arr){
      const a=[...arr];
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }
    function pickWrongCats(correctKey){
      const others=CATS.filter(c=>c.key!==correctKey);
      return shuffle(others).slice(0,3);
    }
    function catName(key){ return (CATS.find(c=>c.key===key)||{}).name || key; }

    function setToast(msg, kind="info"){
      toast.textContent=msg;
      toast.classList.add("show");
      toast.style.borderColor =
        kind==="good" ? "rgba(52,211,153,.35)" :
        kind==="bad"  ? "rgba(251,113,133,.40)" :
                        "rgba(255,255,255,.16)";
      clearTimeout(setToast._t);
      setToast._t=setTimeout(()=>toast.classList.remove("show"), 2300);
    }

    function updateTopBadges(){ scoreTop.textContent=state.score; bestTop.textContent=state.best; }
    function updateKPI(){
      qNow.textContent=Math.min(state.idx, state.total);
      qTotal.textContent=state.total;
      rightNow.textContent=state.right;
      streakNow.textContent=state.streak;
      const pct = state.total ? (Math.min(state.idx, state.total)/state.total)*100 : 0;
      progBar.style.width=pct+"%";
    }
    function loadBest(){
      const b=Number(localStorage.getItem(LS_BEST)||"0");
      state.best=Number.isFinite(b)?b:0;
    }
    function saveBestIfNeeded(){
      if(state.score>state.best){
        state.best=state.score;
        localStorage.setItem(LS_BEST, String(state.best));
        setToast("Жаңа рекорд тіркелді!", "good");
      }
    }

    function setMode(mode){
      state.mode=mode;
      for(const btn of [tabQuiz,tabBuilder,tabTheory]){
        btn.setAttribute("aria-selected","false");
        btn.classList.remove("primary");
      }
      viewQuiz.hidden=true; viewBuilder.hidden=true; viewTheory.hidden=true;

      if(mode==="quiz"){
        tabQuiz.setAttribute("aria-selected","true"); tabQuiz.classList.add("primary");
        viewQuiz.hidden=false;
        viewTitle.textContent="Ойконимді тап";
        modeName.textContent="Ойконимді тап";
        nextBtn.hidden=false; newRoundBtn.hidden=false;
        startRound();
      }else if(mode==="builder"){
        tabBuilder.setAttribute("aria-selected","true"); tabBuilder.classList.add("primary");
        viewBuilder.hidden=false;
        viewTitle.textContent="Құрастыр";
        modeName.textContent="Құрастыр";
        nextBtn.hidden=true; newRoundBtn.hidden=true;
        renderBuilder();
      }else{
        tabTheory.setAttribute("aria-selected","true"); tabTheory.classList.add("primary");
        viewTheory.hidden=false;
        viewTitle.textContent="Теория";
        modeName.textContent="Теория";
        nextBtn.hidden=true; newRoundBtn.hidden=true;
      }
    }

    // Quiz
    function startRound(){
      state.order = shuffle(DATA.map((_,i)=>i)).slice(0, state.total);
      state.idx=0; state.locked=false;
      state.score=0; state.right=0; state.streak=0;
      explainBox.style.display="none";
      updateTopBadges(); updateKPI();
      renderQuestion();
      setToast("Жаңа раунд басталды.", "info");
    }

    function renderQuestion(){
      state.locked=false;
      explainBox.style.display="none";
      explainBox.innerHTML="";

      if(state.idx>=state.total){
        qName.textContent="Раунд аяқталды";
        qHint.textContent=`Нәтиже: ${state.right}/${state.total}. Ұпай: ${state.score}.`;
        choices.innerHTML="";
        saveBestIfNeeded();
        updateTopBadges();
        setToast("Раунд аяқталды. «Жаңа раунд» батырмасын бас.", "info");
        return;
      }

      const item = DATA[state.order[state.idx]];
      qName.textContent=item.name;
      qHint.textContent=item.hint;

      const wrong = pickWrongCats(item.cat);
      const opts = shuffle([
        { key:item.cat, correct:true, name:catName(item.cat), desc:(CATS.find(c=>c.key===item.cat)||{}).desc || "" },
        ...wrong.map(c=>({ key:c.key, correct:false, name:c.name, desc:c.desc }))
      ]);

      choices.innerHTML="";
      opts.forEach((o, idx)=>{
        const btn=document.createElement("button");
        btn.className="choice";
        btn.type="button";
        btn.dataset.correct=String(o.correct);
        btn.dataset.key=o.key;
        btn.dataset.index=String(idx);
        btn.innerHTML=`<b>${idx+1}. ${o.name}</b><small>${o.desc}</small>`;
        btn.addEventListener("click", ()=>chooseAnswer(btn, item));
        choices.appendChild(btn);
      });

      updateKPI(); updateTopBadges();
    }

    function chooseAnswer(btn, item){
      if(state.locked) return;
      state.locked=true;
      const isCorrect = btn.dataset.correct==="true";
      const all=[...choices.querySelectorAll(".choice")];
      all.forEach(b=>b.disabled=true);

      if(isCorrect){
        btn.classList.add("correct");
        state.right+=1;
        state.streak+=1;
        const gain = 10 + Math.min(state.streak,5)*2;
        state.score+=gain;
        setToast(`Дұрыс! +${gain} ұпай`, "good");
      }else{
        btn.classList.add("wrong");
        state.streak=0;
        const correctBtn=all.find(b=>b.dataset.correct==="true");
        if(correctBtn) correctBtn.classList.add("correct");
        setToast("Қате. Түсіндірмені оқы.", "bad");
      }

      explainBox.style.display="block";
      explainBox.innerHTML=`
        <div><b>Түсіндірме:</b> ${item.explain}</div>
        <div class="mini" style="margin-top:8px">Әдіс: атау құрамын (компоненттер), табиғи орта мен тарихи қабатты салыстыр.</div>
      `;
      updateKPI(); updateTopBadges();
    }

    function nextStep(){
      if(state.mode!=="quiz") return;
      if(state.idx>=state.total) return;
      state.idx+=1;
      renderQuestion();
    }

    // Builder
    function renderBuilder(){
      chips.innerHTML="";
      const all=[...PART_A.map(t=>({t,kind:"A"})), ...PART_B.map(t=>({t,kind:"B"}))];
      all.forEach(obj=>{
        const el=document.createElement("div");
        el.className="chip";
        el.textContent=obj.t;
        el.draggable=true;
        el.dataset.kind=obj.kind;
        el.dataset.text=obj.t;
        el.addEventListener("dragstart",(e)=>{
          e.dataTransfer.setData("text/plain", JSON.stringify({kind:obj.kind, text:obj.t}));
        });
        chips.appendChild(el);
      });

      for(const zone of [slotA,slotB]){
        zone.addEventListener("dragover",(e)=>{ e.preventDefault(); zone.style.borderColor="rgba(125,211,252,.38)"; });
        zone.addEventListener("dragleave",()=>{ zone.style.borderColor="rgba(255,255,255,.14)"; });
        zone.addEventListener("drop",(e)=>{
          e.preventDefault();
          zone.style.borderColor="rgba(255,255,255,.14)";
          try{
            const payload=JSON.parse(e.dataTransfer.getData("text/plain")||"{}");
            placeInSlot(zone.dataset.slot, payload);
          }catch(_){}
        });
      }
      clearBuild();
    }

    function placeInSlot(slot, payload){
      if(!payload || !payload.text) return;
      if(slot==="A"){
        state.buildA=payload.text;
        slotA.textContent=payload.text;
        slotA.classList.remove("empty");
      }else{
        state.buildB=payload.text;
        slotB.textContent=payload.text;
        slotB.classList.remove("empty");
      }
      refreshBuiltWord();
    }

    function refreshBuiltWord(){
      const a=state.buildA, b=state.buildB;
      builtWord.textContent=(a && b) ? (a+b) : "—";
      buildExplain.style.display="none";
      buildExplain.innerHTML="";
    }

    function clearBuild(){
      state.buildA=null; state.buildB=null;
      slotA.textContent="1-бөлік (мысалы: Ақ, Қара, Талды…)";
      slotB.textContent="2-бөлік (мысалы: су, тау, төбе…)";
      slotA.classList.add("empty"); slotB.classList.add("empty");
      builtWord.textContent="—";
      buildExplain.style.display="none"; buildExplain.innerHTML="";
    }

    function guessCategory(a,b){
      const A=a.toLowerCase(), B=b.toLowerCase();
      if(B.includes("су")) return "natural";
      if(["тау","төбе"].some(t=>B.includes(t))){
        if(["темір","жез"].some(x=>A.includes(x))) return "econ";
        return "natural";
      }
      if(B.includes("қорған") || B.includes("орда")) return "history";
      return "natural";
    }

    function checkBuild(){
      const a=state.buildA, b=state.buildB;
      if(!a || !b){ setToast("Екі бөлікті де орналастыр.", "bad"); return; }
      const w=a+b;
      const key=NORMALIZE(w);
      const hit=DATA.find(d=>NORMALIZE(d.name)===key);

      buildExplain.style.display="block";
      if(hit){
        buildExplain.innerHTML=`
          <div><b>Табылды:</b> <span style="color:var(--accent)">${hit.name}</span></div>
          <div style="margin-top:6px"><b>Топ:</b> ${catName(hit.cat)}</div>
          <div style="margin-top:6px"><b>Түсіндірме:</b> ${hit.explain}</div>
        `;
        setToast("Жарайсың! Дұрыс атау.", "good");
      }else{
        const g=guessCategory(a,b);
        buildExplain.innerHTML=`
          <div><b>Құрастырылған атау:</b> <span style="color:var(--accent)">${w}</span></div>
          <div style="margin-top:6px"><b>Болжамды топ:</b> ${catName(g)}</div>
          <div style="margin-top:6px" class="muted">
            Бұл атау деректер жинағында жоқ. Дегенмен құрамдық талдау бойынша уәж ұсынуға болады.
          </div>
        `;
        setToast("Деректе жоқ, бірақ талдау жасалды.", "info");
      }
    }

    function randomBuild(){
      const a=PART_A[Math.floor(Math.random()*PART_A.length)];
      const b=PART_B[Math.floor(Math.random()*PART_B.length)];
      state.buildA=a; state.buildB=b;
      slotA.textContent=a; slotA.classList.remove("empty");
      slotB.textContent=b; slotB.classList.remove("empty");
      refreshBuiltWord();
      setToast("Кездейсоқ құрастырылды.", "info");
    }

    tabQuiz.addEventListener("click", ()=>setMode("quiz"));
    tabBuilder.addEventListener("click", ()=>setMode("builder"));
    tabTheory.addEventListener("click", ()=>setMode("theory"));

    newRoundBtn.addEventListener("click", startRound);
    nextBtn.addEventListener("click", nextStep);

    resetAllBtn.addEventListener("click", ()=>{
      localStorage.removeItem(LS_BEST);
      state.best=0;
      updateTopBadges();
      setToast("Рекорд тазартылды.", "info");
    });

    checkBuildBtn.addEventListener("click", checkBuild);
    clearBuildBtn.addEventListener("click", ()=>{ clearBuild(); setToast("Құрастыру аймағы тазартылды.", "info"); });
    randomBuildBtn.addEventListener("click", randomBuild);

    window.addEventListener("keydown", (e)=>{
      if(state.mode!=="quiz") return;
      const map={"1":0,"2":1,"3":2,"4":3};
      if(e.key in map){
        const btns=[...choices.querySelectorAll(".choice")];
        const b=btns[map[e.key]];
        if(b && !b.disabled) b.click();
      }
      if(e.key==="Enter"){
        if(state.locked) nextStep();
      }
    });

    loadBest();
    updateTopBadges();
    setMode("quiz");
  </script>
</body>
</html>
